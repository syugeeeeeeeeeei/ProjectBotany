# ğŸ› ï¸ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…ç”¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä»¥ä¸‹ã®é †åºã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»é…ç½®ã—ã¦ã„ãã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

## 1. ğŸ“š å…±æœ‰å‹å®šç¾© (Shared Types)

`src/shared/types/` é…ä¸‹ã«é…ç½®ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ Core, Feature, UI ã®ã™ã¹ã¦ã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹ã€Œå…±é€šè¨€èªã€ã§ã™ã€‚

### `src/shared/types/primitives.ts`

æœ€ã‚‚åŸºæœ¬çš„ãªå˜ä½ã§ã™ã€‚

```typescript
/**
 * 2Dåº§æ¨™
 */
export interface Point {
  x: number;
  y: number;
}

/**
 * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¨®åˆ¥
 */
export type PlayerType = "native" | "alien";

/**
 * ãƒ•ã‚§ãƒ¼ã‚ºå®šç¾©
 */
export type GamePhase = "setup" | "main" | "move" | "end";
```

### `src/shared/types/game-schema.ts`

ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ã™ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã§ã™ï¼ˆSource of Truthï¼‰ã€‚

```typescript
import { Point, PlayerType, GamePhase } from "./primitives";

/**
 * ã‚»ãƒ«ï¼ˆãƒã‚¹ç›®ï¼‰ã®çŠ¶æ…‹
 * - CoreãŒç®¡ç†ã—ã€FeatureãŒAPIçµŒç”±ã§èª­ã¿æ›¸ãã™ã‚‹
 */
export interface CellState extends Point {
  /** ãƒã‚¹ã®ç¨®é¡ID (ä¾‹: 'native', 'wasteland', 'alien_core') */
  type: string;
  /** ãƒã‚¹ã«ä¹—ã£ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆID (ä»»æ„) */
  objectId?: string | null;
  /** æ•°å€¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (ä¾‹: æ±šæŸ“åº¦, æ „é¤Šä¾¡) - æ‹¡å¼µç”¨ */
  attributes: Record<string, number>;
}

/**
 * ç›¤é¢å…¨ä½“
 */
export interface FieldState {
  width: number;
  height: number;
  cells: CellState[][];
}

/**
 * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹
 */
export interface PlayerState {
  id: PlayerType;
  name: string;
  /** AP/MPãªã©ã®ãƒªã‚½ãƒ¼ã‚¹ */
  resources: {
    current: number;
    max: number;
  };
  /** å‘ãä¿‚æ•° (1 or -1) */
  facingFactor: number;
  /** å‹åˆ©ã‚¹ã‚³ã‚¢ãªã© */
  score: number;
}

/**
 * ã‚²ãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ…‹ (State Storeã®ãƒ«ãƒ¼ãƒˆ)
 */
export interface GameState {
  /** ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³æ•° */
  currentTurn: number;
  /** ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
  activePlayer: PlayerType;
  /** ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º */
  phase: GamePhase;
  /** ç›¤é¢ãƒ‡ãƒ¼ã‚¿ */
  field: FieldState;
  /** ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ */
  players: Record<PlayerType, PlayerState>;
  /** å‹è€… (nullãªã‚‰é€²è¡Œä¸­) */
  winner: PlayerType | null;
}
```

---

## 2. âš¡ï¸ ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾© (Event Map)

`src/core/types/events.ts` (ã¾ãŸã¯ `shared` ã§ã‚‚å¯) ã«é…ç½®ã—ã¾ã™ã€‚
**ã“ã“ãŒ Feature ã¨ Core ã‚’ç¹‹ãç¥çµŒå›è·¯ã®ä»•æ§˜æ›¸ã«ãªã‚Šã¾ã™ã€‚**

```typescript
import { GameState, CellState, PlayerType } from "@/shared/types/game-schema";
import { ReactNode } from "react";

/**
 * CoreãŒç™ºè¡Œã—ã€FeatureãŒãƒªãƒƒã‚¹ãƒ³ã™ã‚‹å…¨ã‚¤ãƒ™ãƒ³ãƒˆã®å‹å®šç¾©
 * - ã‚­ãƒ¼: ã‚¤ãƒ™ãƒ³ãƒˆå
 * - å€¤: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å‹
 */
export interface CoreEventMap {
  // --- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç³» ---
  /** ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†æ™‚ */
  GAME_INIT: (state: GameState) => void;
  /** ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ */
  TURN_START: (state: GameState) => void;
  /** ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†ã®ç›´å‰ (FeatureãŒå‰²ã‚Šè¾¼ã¿å‡¦ç†ã‚’è¡Œã†ã‚¿ã‚¤ãƒŸãƒ³ã‚°) */
  BEFORE_TURN_END: (state: GameState) => Promise<void> | void;
  /** ã‚¿ãƒ¼ãƒ³çµ‚äº†ç¢ºå®šæ™‚ */
  TURN_END: (state: GameState) => void;

  // --- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç³» (æˆ»ã‚Šå€¤ boolean ã§ä¼æ’­åœæ­¢å¯èƒ½) ---
  /** ã‚»ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã€‚trueã‚’è¿”ã™ã¨å‡¦ç†æ¸ˆã¿ã¨ã—ã¦å¾Œç¶šã‚’ãƒ–ãƒ­ãƒƒã‚¯ */
  CELL_CLICK: (cell: CellState, state: GameState) => boolean | void;
  /** ã‚»ãƒ«ã«ãƒ›ãƒãƒ¼ã—ãŸæ™‚ */
  CELL_HOVER: (cell: CellState, state: GameState) => void;

  // --- UIæ³¨å…¥ç³» (Featureã¯ReactNodeã‚’è¿”ã™) ---
  /** ãƒã‚¹ã®ä¸Šã«é‡ã­ã‚‹è¡¨ç¤ºç‰© (Outlineãªã©) ã®å•ã„åˆã‚ã› */
  RENDER_CELL_OVERLAY: (cell: CellState) => ReactNode;
  /** ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ãªã©ã®ã‚¹ãƒ­ãƒƒãƒˆã¸ã®UIæ³¨å…¥ */
  RENDER_UI_SLOT: (slotId: string, player: PlayerType) => ReactNode;
}
```

---

## 3. ğŸ“œ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¨å„ªå…ˆåº¦ (Feature Manifest)

`src/shared/types/architecture.ts` ã«é…ç½®ã—ã¾ã™ã€‚

### å‹å®šç¾©

```typescript
import { CoreEventMap } from "@/core/types/events";

/**
 * å„ªå…ˆåº¦å®šæ•°
 * æ•°å€¤ãŒå¤§ãã„ã»ã©å…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹ã€ã¾ãŸã¯UIã®æ‰‹å‰ã«è¡¨ç¤ºã•ã‚Œã‚‹
 */
export const PRIORITY = {
  SYSTEM_CRITICAL: 1000, // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€æœ€é‡è¦UI
  GAME_RULE: 500, // å‹æ•—åˆ¤å®šã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«
  CARD_EFFECT: 300, // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãªã©ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  PASSIVE_EFFECT: 100, // ä¾µé£Ÿã€è‡ªç„¶å›å¾©ãªã©ã®è‡ªå‹•å‡¦ç†
  DECORATION: 0, // è£…é£¾ã€éŸ³ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
} as const;

/**
 * Feature Manifestå®šç¾©
 * ã™ã¹ã¦ã®Featureã¯ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«å¾“ã£ã¦ export ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„
 */
export interface FeatureManifest {
  /** æ©Ÿèƒ½ã®ä¸€æ„ãªID */
  key: string;

  /** å®Ÿè¡Œå„ªå…ˆåº¦ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0) */
  priority?: number;

  /** Coreã‚¤ãƒ™ãƒ³ãƒˆã¸ã®ãƒªã‚¹ãƒŠãƒ¼å®šç¾© */
  listeners?: Partial<CoreEventMap>;

  /** è¨­å®š (ä»»æ„) */
  config?: Record<string, unknown>;
}
```

### Feature ã®å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«

`src/features/alien-expansion/index.ts` ã®ä¾‹ã§ã™ã€‚

```typescript
import { FeatureManifest, PRIORITY } from "@/shared/types/architecture";
import { gameActions } from "@/core/api"; // Coreæ“ä½œç”¨API (å¾Œè¿°)

// ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿä½“ (åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†ã‘ã‚‹ã®ãŒæœ›ã¾ã—ã„)
const handleTurnStart = (state: any) => {
  // ä¾‹: 30%ã®ç¢ºç‡ã§å¤–æ¥ç¨®ã‚’åºƒã’ã‚‹
  if (Math.random() > 0.7) {
    // âš ï¸ Storeã‚’ç›´æ¥è§¦ã‚‰ãšã€å¿…ãšCore APIçµŒç”±ã§æ“ä½œã™ã‚‹
    // gameActions.field.mutateCell(...)
    console.log("ğŸ„ å¤–æ¥ç¨®ãŒä¾µé£Ÿã—ã¾ã—ãŸ");
  }
};

// ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®export
export const alienExpansionFeature: FeatureManifest = {
  key: "alien-expansion",
  priority: PRIORITY.PASSIVE_EFFECT, // å„ªå…ˆåº¦100

  listeners: {
    // å‹æ¨è«–ãŒåŠ¹ãã®ã§ (state) ã®å‹ã‚’æ›¸ãå¿…è¦ãŒãªã„
    TURN_START: handleTurnStart,

    // UIæ³¨å…¥
    RENDER_CELL_OVERLAY: (cell) => {
      if (cell.type === "alien_core") {
        return null; // ReactNodeã‚’è¿”ã™ (ã“ã“ã§ã¯çœç•¥)
      }
    },
  },
};
```

---

## 4. ğŸ›¡ï¸ ESLint è¨­å®š (eslint.config.ts)

`jiti` å°å…¥æ¸ˆã¿ã§ `eslint.config.ts` (Flat Config) ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®æ§‹æˆã§ã™ã€‚
`eslint-plugin-import` ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé–“ã®ä¾å­˜ãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚

â€» Flat Config ã§ `eslint-plugin-import` ã‚’ä½¿ã†å ´åˆã€äº’æ›æ€§ã®ãŸã‚ã«å°‘ã—å·¥å¤«ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã¯æ¨™æº–çš„ãªè¨­å®šä¾‹ã§ã™ã€‚

```typescript
import js from "@eslint/js";
import globals from "globals";
import tseslint from "typescript-eslint";
import importPlugin from "eslint-plugin-import";

export default tseslint.config(
  { ignores: ["dist", "node_modules"] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ["**/*.{ts,tsx}"],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™»éŒ²
      import: importPlugin,
    },
    settings: {
      // TypeScriptã®è§£æ±ºè¨­å®š
      "import/resolver": {
        typescript: {
          project: "./tsconfig.json",
        },
      },
    },
    rules: {
      // --- ğŸ—ï¸ Core-Feature ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¿è­·ãƒ«ãƒ¼ãƒ« ---

      "import/no-restricted-paths": [
        "error",
        {
          zones: [
            // ğŸš« ãƒ«ãƒ¼ãƒ«1: Coreã¯ Feature ã«ä¾å­˜ã—ã¦ã¯ãªã‚‰ãªã„
            {
              target: "./src/core",
              from: "./src/features",
              message:
                "Architecture Violation: Core cannot import from Features.",
            },
            // ğŸš« ãƒ«ãƒ¼ãƒ«2: Sharedã¯ App, Core, Feature ã«ä¾å­˜ã—ã¦ã¯ãªã‚‰ãªã„ (ç´”ç²‹ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ã¹ã)
            {
              target: "./src/shared",
              from: ["./src/app", "./src/core", "./src/features"],
              message: "Architecture Violation: Shared library must be pure.",
            },
            // ğŸš« ãƒ«ãƒ¼ãƒ«3: App (Wiringå±¤) ä»¥å¤–ãŒ Appå±¤ã‚’å‚ç…§ã—ã¦ã¯ãªã‚‰ãªã„
            {
              target: ["./src/core", "./src/features", "./src/shared"],
              from: "./src/app",
              message:
                "Architecture Violation: Lower layers cannot import from App layer.",
            },
            // ğŸš« ãƒ«ãƒ¼ãƒ«4: FeatureåŒå£«ã®ç›´æ¥å‚ç…§ç¦æ­¢ (Sharedã‹Coreã‚’çµŒç”±ã›ã‚ˆ)
            // â€»ã“ã‚Œã¯å³å¯†ã«ã‚„ã‚‹ãªã‚‰Featureã”ã¨ã«å®šç¾©ãŒå¿…è¦ã ãŒã€ã¾ãšã¯ã€Œfeaturesã‹ã‚‰featuresã€ã‚’ç¦æ­¢ã—ã¦
            //   è‡ªåˆ†è‡ªèº«ã¸ã®å‚ç…§ã ã‘è¨±å¯ã™ã‚‹è¨­å®šãŒå¿…è¦ã€‚
            //   ç°¡æ˜“çš„ã«ã¯ 'import/no-relative-parent-imports' ã‚’æ¤œè¨ã™ã‚‹ã‹ã€
            //   ã‚ã‚‹ã„ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚«ãƒãƒ¼ã™ã‚‹æ–¹é‡ã§ã‚‚å¯ã€‚
          ],
        },
      ],

      // ãã®ä»–ã®æ¨å¥¨ãƒ«ãƒ¼ãƒ«
      "import/order": [
        "warn",
        {
          groups: [
            "builtin",
            "external",
            "internal",
            "parent",
            "sibling",
            "index",
          ],
          "newlines-between": "always",
          alphabetize: { order: "asc", caseInsensitive: true },
        },
      ],
    },
  }
);
```

### è£œè¶³ï¼šESLint ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚‚ã— `eslint-plugin-import` ãŒã¾ã å…¥ã£ã¦ã„ãªã„å ´åˆã¯è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```bash
npm install --save-dev eslint-plugin-import eslint-import-resolver-typescript
# ã¾ãŸã¯ yarn add -D ...

```
