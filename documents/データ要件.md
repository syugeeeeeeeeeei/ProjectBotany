できるだけ構造は簡潔にフラットにかつ必要十分にして、ソースコードとして実装する際はクリーンで構造化された定義を心がけて可読性を高める。

---

# 📊 データ構造要件

このセクションでは、ゲームの内部で状態を管理するためのデータ構造を、「パラメーター名: 型」と「説明」の形式で定義します。

---

#### 🎮 ゲーム全体の状態 (`GameState`)

ゲーム全体の現在の状況を把握するための、最も上位のデータ構造です。

* `currentTurn: number`
    現在のターン数を示す数値です。
* `maximumTurns: number`
    ゲームが終了する総ターン数を示す数値です（例：6〜8ターン）。この数に達すると勝敗が決まります。
* `activePlayerId: 'native_side' | 'alien_side'`
    現在手番のプレイヤー（在来種サイドか外来種サイドか）を識別するための値です。
* `gameField: FieldState`
    ゲーム盤面であるフィールドの、すべてのマスの状態を記録した「フィールドの状態」という入れ物への参照です。
* `playerStates: { [id: 'native_side' | 'alien_side']: PlayerState }`
    各プレイヤー（在来種サイドと外来種サイド）がそれぞれ持っている情報（手札、エンバイロメントなど）をまとめた「プレイヤーの状態」という入れ物への参照です。プレイヤーID（例：`'native_side'`, `'alien_side'`) をキーとして、各プレイヤーの情報を管理します。
* `currentPhase: 'environment_phase' | 'summon_phase' | 'activation_phase'`
    今、ターンの中のどの段階（エンバイロメントフェーズ、召喚フェーズ、活性フェーズなど）にいるかを記録します。
* `isGameOver: boolean`
    ゲームがもう終わったかどうかを真偽値（`true`か`false`）で示します。
* `winningPlayerId: 'native_side' | 'alien_side' | null`
    ゲームが終わった場合に、どちらのサイドが勝ったのかを識別するための値です。引き分けの場合は「null」として記録されます。
* `activeAlienInstances: { [instanceId: string]: ActiveAlienInstance }`
    フィールドに配置されて活動している、ひとつひとつの外来種（コマ）の詳しい情報を、そのインスタンス固有の識別子をキーとしてまとめた入れ物です。

---

#### 📜 ゲームログ (`GameLog`)

ゲーム開始から終了までの全てのイベントを記録する、最上位の履歴データ構造です。ゲームの再現やAIの学習に利用されます。

* `initialGameState: GameState`
    ゲーム開始時の初期状態を記録します。これにより、ゲームを任意の時点から再現できます。
* `events: GameEvent[]`
    ゲーム中に発生したすべてのイベントの配列です。

---

#### 📝 ゲームイベント (`GameEvent`)

`GameLog`内に記録される、ゲームの各ステップで発生する具体的なアクションや状態変化を表現するデータ構造です。

* `turn: number`
    イベントが発生したターン数です。
* `phase: 'environment_phase' | 'summon_phase' | 'activation_phase'`
    イベントが発生したフェーズ（例: `'environment_phase'`, `'summon_phase'`, `'activation_phase'`）です。
* `player: 'native_side' | 'alien_side'`
    イベントを実行したプレイヤーを識別します。
* `eventType: string`
    イベントの種類（例: `'card_played'`, `'alien_moved'`, `'game_over'`, `'cell_state_changed'`, `'alien_grown'`など）を示す文字列です。
* `payload: object`
    イベントの種類に応じた詳細情報が含まれます。具体的な型は各イベントタイプに応じて定義されます。

##### `GameEvent` の `payload` 例

* `'card_played'` (カード使用時)
    * `cardInstanceId: string`
        使用されたカードのインスタンスIDです。
    * `cardDefinitionId: string`
        カード定義IDです。
    * `targetCells?: { x: number; y: number }[]`
        ターゲットマス（駆除・回復など、選択された場合）の座標の配列です。
    * `placementX?: number`
        配置された場合のX座標（外来種の場合）です。
    * `placementY?: number`
        配置された場合のY座標（外来種の場合）です。
    * `costPaid: number`
        消費したエンバイロメントの量です。

* `'alien_moved'` (外来種移動時)
    * `alienInstanceId: string`
        移動した外来種のインスタンスIDです。
    * `fromX: number`
        移動前のX座標です。
    * `fromY: number`
        移動前のY座標です。
    * `toX: number`
        移動後のX座標です。
    * `toY: number`
        移動後のY座標です。
    * `costPaid: number`
        消費したエンバイロロメントの量です。

* `'alien_grown'` (外来種成長時)
    * `alienInstanceId: string`
        成長した外来種のインスタンスIDです。
    * `previousInvasionPower: number`
        成長前の侵略力です。
    * `currentInvasionPower: number`
        成長後の侵略力です。
    * `previousInvasionShape: 'single' | 'cross' | 'straight' | 'range'`
        成長前の侵略形です。
    * `currentInvasionShape: 'single' | 'cross' | 'straight' | 'range'`
        成長後の侵略形です。
    * `previousGrowthStage: number`
        成長前の段階です。
    * `currentGrowthStage: number`
        成長後の段階です。

* `'cell_state_changed'` (マス状態変化時)
    * `x: number`
        変化したマスのX座標です。
    * `y: number`
        変化したマスのY座標です。
    * `fromCellType: 'native_area' | 'alien_core' | 'alien_invasion_area' | 'empty_area' | 'recovery_pending_area'`
        変化前のマスタイプです。
    * `toCellType: 'native_area' | 'alien_core' | 'alien_invasion_area' | 'empty_area' | 'recovery_pending_area'`
        変化後のマスタイプです。
    * `fromDominantAlienInstanceId?: string | null`
        変化前の支配外来種インスタンスIDです。
    * `toDominantAlienInstanceId?: string | null`
        変化後の支配外来種インスタンスIDです。

* `'alien_removed'` (外来種除去時)
    * `alienInstanceId: string`
        除去された外来種のインスタンスIDです。
    * `reason: string`
        除去理由 (例: `'zero_dominant_cells'`, `'eradicated_by_card'`) を示す文字列です。

* `'game_over'` (ゲーム終了時)
    * `winningPlayerId: 'native_side' | 'alien_side' | null`
        勝利プレイヤーのID (引き分けの場合は`null`) です。
    * `reason: string`
        ゲーム終了理由 (例: `'turns_exceeded'`, `'native_cells_zero'`, `'alien_cells_zero'`) を示す文字列です。

---

#### 🗺️ フィールドの状態 (`FieldState` と `CellState`)

縦10マス × 横7マスで構成されるゲーム盤面（フィールド）全体の情報と、その中の個々のマスの情報を管理する入れ物です。

##### フィールド全体のデータ (`FieldState`)

* `width: number`
    フィールドが横に何マスあるかを示す数値です。
* `height: number`
    フィールドが縦に何マスあるかを示す数値です。
* `cells: CellState[][]`
    フィールド上のすべてのマスについて、そのマスの詳しい情報（個々のマスの状態）を、縦と横の並び（二次元配列）で管理します。

##### 個々のマスの状態 (`CellState`)

* `x: number`
    マスの横方向の位置を示す数値です。
* `y: number`
    マスの縦方向の位置を示す数値です。
* `cellType: 'native_area' | 'alien_core' | 'alien_invasion_area' | 'empty_area' | 'recovery_pending_area'`
    そのマスが今、どのような状態にあるかを示します。
* `ownerId: 'native_side' | 'alien_side' | null`
    そのマスをどちらのサイド（在来種サイドか外来種サイドか）が支配しているかを識別するための値です。外来種が支配するマスについては、`dominantAlienInstanceId`が紐づく外来種コマのサイドが支配者となります。空マスや再生待機マスであれば`null`となります。
* `alienInstanceId: string | null`
    もしそのマスが「外来種マス」（コマが置かれた場所）であれば、そのマスに置かれている外来種が、どの「アクティブな外来種インスタンス」なのかを識別するための特別な文字列です。
* `dominantAlienInstanceId: string | null`
    このマスを現在支配している外来種コマのIDです。`cellType` が `'alien_invasion_area'` (侵略マス) または `'alien_core'` (外来種マス) の場合に設定されます。複数の外来種が同じ侵略マスを対象とした場合、上書きルールに基づいてIDが更新されます。`null` の場合は支配している外来種コマがいないことを示します (例: 在来種マス)。
* `recoveryPendingTurn: number | null`
    もしそのマスが「再生待機マス」であれば、いつそのマスが再生待機状態になったのか（何ターン前に灰色になったのか）を示す数値です。これにより、再生までの残りターン数を計算します。

---

#### 🌿 アクティブな外来種インスタンスの状態 (`ActiveAlienInstance`)

フィールドに実際に召喚されて置かれている、ひとつひとつの外来種（コマ）に関する、ゲーム中に変化する情報（ランタイム情報）を管理する入れ物です。

* `instanceId: string`
    フィールドに置かれるたびに新しく発行される、その外来種コマの固有の識別文字列です。
* `spawnedTurn: number`
    このインスタンスがフィールドに配置されたターン数です。同コストの外来種間の優先度判定に使用します。
* `cardDefinitionId: string`
    この外来種コマが、元々どの「カードの定義データ」から生まれたのかを示すIDです。
* `currentX: number`
    その外来種コマがフィールドのどのマス（X座標）に**現在置かれているか**を示す数値です。移動により変化します。
* `currentY: number`
    その外来種コマがフィールドのどのマス（Y座標）に**現在置かれているか**を示す数値です。移動により変化します。
* `currentInvasionPower: number`
    この外来種コマが、今現在どれだけの侵略力を持っているかを示す数値です。「成長」によって変化する可能性があります。
* `currentInvasionShape: 'single' | 'cross' | 'straight' | 'range'`
    この外来種コマが、今現在どのようなパターンで侵略するかを示す文字列です。「成長」によって変化する可能性があります。
* `currentGrowthStage: number`
    この外来種コマが今、成長プロセスのどの段階にいるかを示す数値です（例：0から始まる）。
* `turnsSinceLastAction: number`
    この外来種コマがフィールドに配置されてから、または**最後に移動してから**、何ターン経過したかを示す数値です。これは「成長」の条件判定に使われます。

---

#### 🃏 カードの定義 (`CardDefinition`)

ゲームに登場するすべてのカードについて、その種類や効果など、ゲーム開始前から決まっている「静的な情報」（定義データ）をまとめた入れ物です。ゲーム中にこの情報は変わりません。

* `id: string`
    そのカードの種類を識別するための固有の文字列です。
* `name: string`
    カードの表示名です（例：オオキンケイギク、強力駆除剤）。
* `description: string`
    そのカードの効果や特徴を説明するテキストです。
* `cost: number`
    そのカードを使うために必要なエンバイロメントの量を示す数値です。
* `cardType: 'alien' | 'eradication' | 'recovery'`
    そのカードが「`alien`（外来種）」「`eradication`（駆除）」「`recovery`（回復）」のどれであるかを記録します。
* `imagePath: string`
    そのカードの画像ファイルがどこにあるかを示す文字列です。

##### 外来種カードに固有の情報 (`cardType`が`'alien'`の場合にのみ関連)

* `baseInvasionPower?: number`
    初期状態での侵略力です。
* `baseInvasionShape?: 'single' | 'cross' | 'straight' | 'range'`
    初期状態での侵略パターン（`'single'`, `'cross'`, `'straight'`, `'range'`）です。
* `canGrow?: boolean`
    このカードが「成長」の特性を持つかどうかを示す真偽値です。
* `growthConditions?: GrowthCondition[]`
    もし成長可能なら、どのような条件（例：配置から2ターン経過）で成長が起こるかを定義した情報の一覧です。
* `growthEffects?: GrowthEffect[]`
    成長した場合に、侵略力や侵略形がどう変化するかを具体的に定義した情報の一覧です。

##### 駆除カードに固有の情報 (`cardType`が`'eradication'`の場合にのみ関連)

* `targetType?: 'cell' | 'alien_plant'`
    駆除効果を適用するのが「`cell`（マス）」なのか、それともフィールド上の「`alien_plant`（外来種コマ）」なのかを示す文字列です。
* `removalMethod?: 'direct_n_cells' | 'range_selection' | 'target_alien_and_its_dominant_cells'`
    駆除するマスの選び方（`'direct_n_cells'`でNマスを個別に選ぶのか、`'range_selection'`で指定した場所を中心に範囲で選ぶのか、`'target_alien_and_its_dominant_cells'`で外来種コマとそれに紐づく支配マスをすべて駆除するのか）を示す文字列です。
* `postRemovalState?: 'empty_area' | 'recovery_pending_area'`
    駆除されたマスが「`empty_area`（空マス）」になるのか、それともすぐに「`recovery_pending_area`（再生待機マス）」になるのかを示す文字列です。

##### 回復カードに固有の情報 (`cardType`が`'recovery'`の場合にのみ関連)

* `recoveryMethod?: 'direct_n_cells' | 'range_selection'`
    回復するマスの選び方（`'direct_n_cells'`でNマスを個別に選ぶのか、`'range_selection'`で指定した場所を中心に範囲で選ぶのか）を示す文字列です。

##### 使用制限の情報（駆除・回復カードに適用）

* `usageLimit?: number | null`
    そのカードが1ゲーム中に使用できる最大回数を示す数値です。`null`の場合は無制限、`1`は使い切り、`2`は2回までといった具体的な回数です。
* `cooldownTurns?: number | null`
    カードを使った後、次にそのカードが使用可能になるまでのターン数を示す数値です。`null`の場合はクールタイムなしです。

---

#### 👤 プレイヤーの状態 (`PlayerState`)

各プレイヤー（在来種サイドと外来種サイド）がそれぞれ持っている、ゲーム中に変化する情報（ランタイム情報）を管理する入れ物です。

* `playerId: 'native_side' | 'alien_side'`
    そのプレイヤーがどちらのサイドか（`'native_side'`か`'alien_side'`）を示す識別子です。
* `playerName: string`
    表示用の名前です。
* `currentEnvironment: number`
    そのプレイヤーが今使えるエンバイロメントの量を示す数値です。
* `maxEnvironment: number`
    そのプレイヤーが保有できるエンバイロメントの最大量です。エンバイロメントフェーズで増加します。
* `cardLibrary: PlayerCardInstance[]`
    そのプレイヤーがゲーム中に使用できる全てのカードのインスタンスのリストです。
* `cooldownActiveCards: { cardId: string, turnsRemaining: number }[]`
    クールタイム中のカードがどれで、あと何ターン待てば使えるようになるかを記録した一覧です。各要素は、カード定義IDとその残りターン数を含みます。
* `limitedCardsUsedCount: { [cardId: string]: number }`
    ゲーム中に使える回数が決まっているカードについて、どのカードを何回使ったかを記録した、カード定義IDをキーとするマップ（辞書）です。

---

#### その他のデータ構造（参照用）

* **成長条件 (`GrowthCondition`)**
    外来種カードの`growthConditions`で使用される型です。
    * `type: 'turns_since_last_action'`
        条件の種類を示します。
    * `value: number`
        満たすべき値（例: 2ターン経過）を示します。

* **成長効果 (`GrowthEffect`)**
    外来種カードの`growthEffects`で使用される型です。
    * `type: 'increase_invasion_power' | 'change_invasion_shape'`
        効果の種類を示します。
    * `value?: number`
        効果量（侵略力増加の場合）を示す数値です。
    * `newShape?: 'single' | 'cross' | 'straight' | 'range'`
        新しい侵略形（侵略形変更の場合）を示す文字列です。

* **プレイヤーが持つカードのインスタンス (`PlayerCardInstance`)**
    `cardLibrary`に入るカードのランタイム情報です。
    * `instanceId: string`
        このカードインスタンス固有のIDです。
    * `cardDefinitionId: string`
        このカードがどの`CardDefinition`に基づくかを示すIDです。
    * // 必要であれば、このカードインスタンス固有の状態 (例: 強化状態、一時的な効果など) をここに追加