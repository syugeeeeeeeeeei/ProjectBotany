# 🌿 リポジトリアーキテクチャルール（feature-based）

本ドキュメントは、ProjectBotany における**機能ベース（feature-based）アーキテクチャ**の定義と、その整合性を保つための運用ルールを定めたものです。

## 🚀 1. feature-based アーキテクチャとは

機能ベースアーキテクチャとは、コードを「コンポーネント」「ロジック」「型」といった技術的なレイヤーで分けるのではなく、**「カードを使う」「外来種を動かす」といったゲーム上の「機能（ドメイン）」単位でグループ化する**設計手法です。

各機能は自己完結しており、その機能に必要な UI、ロジック、フック、型が 1 つのディレクトリ内に集約されます。

## 💡 2. feature-based アーキテクチャを導入した動機

### ❌ 以前の課題（何に困っていたか）

- **ドメインの断片化**: 1 つの機能（例：召喚）を変更するために、`components/`、`logic/`、`store/`、`App.tsx` のすべてを横断して探す必要があり、認知負荷が高かった。
- **影響範囲の不明確さ**: 巨大な `gameLogic.ts` や `UIStore.ts` に依存していたため、一部の修正が予期せぬ場所でバグを引き起こすリスクがあった。
- **再利用・削除の困難さ**: 特定の機能を一時的に無効化したり、別のプロジェクトへ移植したりすることが構造的に困難だった。

### ✅ 導入による恩恵（何を求めてこの構成にしたか）

- **メンテナンス性の向上**: 機能ディレクトリ内を見るだけで、その機能の全容が把握できる。
- **堅牢な依存関係**: 機能間の不要な結合を排除し、循環参照などのスパゲッティコード化を未然に防ぐ。
- **開発速度の安定**: 機能追加時に既存コードへの影響を最小限に抑えられ、チーム開発でのコンフリクトも減少する。

## 📂 3. ディレクトリ・ファイルツリーの例

リポジトリは以下の 3 つの主要な層で構成されます。

```text
src/
├── app/                # 全体の統合層（Storeの定義、メインレイアウト、エントリーポイント）
├── features/           # ゲームの各機能（ドメイン単位でディレクトリを作成）
│   └── [feature-name]/
│       ├── domain/     # 純粋な計算・バリデーション（React非依存のTypeScript）
│       ├── ui/         # 3Dコンポーネント、Styled Components
│       ├── hooks/      # StoreとDomainを接続するカスタムフック
│       └── index.ts    # Public API（外部に公開するインターフェース）
├── shared/             # 共通基盤（型定義、定数、共通ユーティリティ、基盤コンポーネント）
└── data/               # マスターデータ（カード定義など）

```

## 🛠️ 4. 新たな機能を追加するための方法

新しい機能（例：`sound-system` や `special-ability`）を追加する際の手順は以下の通りです。

1. **ディレクトリ作成**: `src/features/` 配下に新しいディレクトリを作成する。
2. **Domain の定義**: React に依存しない純粋なロジックを `domain/` に記述する。
3. **UI の構築**: 必要な 3D オブジェクトや UI 要素を `ui/` に作成する。
4. **Public API の作成**: `index.ts` を作成し、`app/` 層で使いたいコンポーネントや関数のみを `export` する。
5. **app/層での統合**: `src/app/App.tsx` や `src/app/store/` から、作成した機能の `index.ts` を経由して読み込み、全体に組み込む。

## ⚠️ 5. アーキテクチャをきれいに保つために遵守すべきルール

アーキテクチャの崩壊を防ぐため、以下のルールを**絶対**に遵守してください。

### ① 依存関係の一方向性（レイヤーの壁）

依存の方向は常に **`shared` → `features` → `app**` である必要があります。

- `shared` は、`features` や `app` のコードを参照してはいけません。
- `features` は、`app` のコードを参照してはいけません。
- インポートにはエイリアス `@/` を使用し、トップダウンで記述してください。

### ② 機能間の「相互参照」禁止

- `features/move-alien` が `features/play-card` 内のファイルを直接インポートすることは禁止です。
- もし複数の機能で共有したいロジックや UI が発生した場合は、それを `shared/` 層へ昇格させてください。

### ③ Public API（カプセル化）の徹底

- 他のレイヤー（特に `app/`）が feature 内部をインポートする際は、必ず **`index.ts`** を経由してください。
- `ui/` や `domain/` 内の個別ファイルに直接アクセスしてはいけません。これは内部実装の隠蔽（カプセル化）を目的としています。

### ④ Domain と UI の分離

- `domain/` 内のロジックには、`react` や `three.js` のオブジェクト、フックを混ぜないでください。
- 計算ロジックをピュアな TypeScript 関数として保つことで、テストが容易になり、ゲームルールの変更に強いコードになります。
