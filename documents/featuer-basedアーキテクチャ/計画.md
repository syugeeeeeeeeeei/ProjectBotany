## 🌿 ProjectBotany feature-based リファクタリング計画書

本計画書は、現在のレイヤーベース（機能が技術要素ごとに分散している状態）の構成から、ドメイン知識を中心とした機能ベース（feature-based）の構成へ移行するための指針です。

---

### 1. リファクタリングの動機

* **ドメインの断片化の解消**: 現在、「外来種の移動」や「カード召喚」といった一つのゲーム体験に関わるロジックが `gameLogic.ts`、`UIStore.ts`、`App.tsx`、各コンポーネントに分散しており、機能の追加・削除や仕様変更の際の影響範囲の特定が困難です。
* **メンテナンス性の向上**: 機能単位でディレクトリを独立させることで、特定の機能（例：移動機能）をフラグ一つで無効化したり、他の機能に影響を与えずに入れ替えたりすることを可能にします。
* **認知負荷の低減**: 開発者がコードを追う際、プロジェクト全体を探索するのではなく、特定の機能ディレクトリ内（例：`features/play-card`）で関連するUI、ロジック、フックを完結して理解できるようにします。

---

### 2. feature-based なリポジトリを作成する上でのルール

* **依存関係の一方向性**: `shared` → `features` → `app` という依存関係の方向を厳守します。
* `shared` 内のコードは `features` や `app` を参照してはいけません。
* `features` 内の各ディレクトリ（例：`move-alien` と `play-card`）は互いに直接参照してはいけません（循環参照の防止）。


* **カプセル化（Public API）**: 各 feature ディレクトリに `index.ts` を置き、外部（`app` 層など）に公開して良いコンポーネント、フック、関数のみを export します。内部的な `domain` ロジックは隠蔽します。
* **Domain と UI の分離**: 各 feature 内で、純粋なゲームルール（React 非依存）は `domain/` に、描画に関するコードは `ui/` に配置します。

---

### 3. このリファクタリング計画で遵守すべきルール

* **UI パリティの絶対死守**: 現在の `three.js` を用いた Canvas 描画、カメラ位置（`[0, 15, 14]`）、視野角（`FOV: 70`）、手札の paging、カードのデザイン、配置座標などの定数値は一切変更せず、デザインを崩さないように安全に既存のコンポーネントからそのまま移植します。
* **ロジックの非改変（リファクタリングに専念）**: 今回の移行中、ゲームルールの変更やバグ修正は同時に行わず、既存の `gameLogic.ts` や `UIStore.ts` の処理を「場所を移動させるだけ」に留めます。
* **インクリメンタルな移行**: 一気に全てを変えるのではなく、まずは基盤（`shared`）を整え、UI を feature ごとに切り分け、最後にロジックを分散させる手順で進めます。

---

### 4. ディレクトリ構成（ファイルツリー）

リファクタリング完了後の構成は以下の通りです。

```text
src/
├── app/                        # アプリケーション全体の統合・エントリー層
│   ├── store/
│   │   ├── useGameStore.ts     # 盤面・ユニットの実データ管理
│   │   └── useUIStore.ts       # 通知・選択状態等のUI状態管理
│   ├── App.tsx                 # 各Featureを統合し、全体のレイアウトを構築
│   └── main.tsx                # Reactのエントリーポイント
├── features/                   # ★ゲームの各機能（ドメイン単位）
│   ├── move-alien/             # 機能：外来種の移動
│   │   ├── domain/             # 純粋な計算（バリデーション、コスト計算）
│   │   │   ├── moveValidation.ts
│   │   │   └── moveCost.ts
│   │   ├── ui/                 # 表示（移動ガイド等）
│   │   │   └── MoveGuide.tsx
│   │   ├── hooks/              # UIとDomainの接続
│   │   │   └── useMoveAlien.ts
│   │   └── index.ts            # 公開インターフェース
│   ├── play-card/              # 機能：カード使用（召喚・駆除・回復）
│   │   ├── domain/             # 純粋な計算（範囲計算、発動条件チェック）
│   │   │   ├── effectCalculator.ts
│   │   │   └── playValidator.ts
│   │   ├── ui/                 # 表示（プレビュー、操作ボタン）
│   │   │   ├── EffectPreview.tsx
│   │   │   └── ActionButtons.tsx
│   │   ├── hooks/
│   │   │   └── usePlayCard.ts
│   │   └── index.ts
│   ├── turn-system/            # 機能：ターンの進行管理
│   │   ├── domain/             # 純粋な計算（プレイヤー交代、ターンカウント）
│   │   │   └── turnLogic.ts
│   │   ├── ui/                 # 表示（ターン交代バナー）
│   │   │   └── TurnBanner.tsx
│   │   ├── hooks/
│   │   │   └── useTurnManager.ts
│   │   └── index.ts
│   ├── ecosystem-activation/   # 機能：活性フェーズの生態系更新
│   │   ├── domain/             # 純粋な計算（成長・拡散・再生のルール）
│   │   │   ├── alienGrowth.ts  # 外来種の成長
│   │   │   ├── alienExpansion.ts # 外来種の拡散
│   │   │   └── nativeRestoration.ts # 在来種の自動再生
│   │   ├── hooks/              # 更新処理の実行タイミングを管理
│   │   │   └── usePhaseResolution.ts
│   │   └── index.ts
│   ├── field-grid/             # 機能：フィールド描画
│   │   ├── ui/
│   │   │   ├── GameBoard3D.tsx
│   │   │   └── Cell3D.tsx      # マスの外観・クリックイベント
│   │   └── domain/
│   │       └── cellHelpers.ts  # CellState生成のヘルパー
│   ├── card-hand/              # 機能：手札とカードリスト
│   │   ├── ui/
│   │   │   ├── Hand3D.tsx
│   │   │   ├── Card3D.tsx
│   │   │   └── CardLibrary.tsx
│   │   └── hooks/
│   │       └── useHandGesture.ts # スワイプ・ページング
│   └── hud/                    # 機能：情報表示（ヘッドアップディスプレイ）
│       └── ui/
│           ├── GameInfo.tsx    # エンバイロメント等のステータス
│           └── UIOverlay.tsx   # スタート・リザルト画面
├── shared/                     # ★共通基盤（アーキテクチャ・インフラ層）
│   ├── components/
│   │   ├── 3d/
│   │   │   ├── SceneController.tsx # カメラ操作
│   │   │   └── BaseObject.tsx      # 共通3Dモデル基盤
│   │   └── debug/
│   │       ├── DebugDialog.tsx     # デバッグパネル
│   │       └── OnScreenConsole.tsx # コンソールログ表示
│   ├── hooks/
│   │   └── useFullscreenHeight.ts
│   ├── utils/
│   │   ├── math.ts             # 座標・方向計算
│   │   └── id.ts               # ID生成（nanoid）
│   ├── types/
│   │   └── game-schema.ts      # GameState, CellState等の基本型
│   └── constants/
│       └── game-config.ts      # 盤面サイズ、最大ターン数等の定数
├── assets/                     # 静的ファイル
└── data/
    └── cardMasterData.ts       # カードの静的定義
```

---

### 5. 実際のリファクタリング計画

リファクタリングは以下の **5フェーズ** で実施します。

#### フェーズ 1：基盤（Shared）の構築

1. `src/shared/types/game-schema.ts` を作成し、現在の `src/types/data.ts` を移動。
2. `src/shared/constants/game-config.ts` を作成し、`src/constants.ts` の値を移動。
3. `src/shared/utils/` に `id.ts` (nanoid等) や `math.ts` (座標計算) を作成。
4. `src/shared/hooks/useFullscreenHeight.ts` を移動。
5. `src/shared/components/` に `SceneController.tsx`、`DebugDialog.tsx`、`OnScreenConsole.tsx` を移動。

#### フェーズ 2：UI コンポーネントの機能別切り分け（最優先・安全）

現在の UI を壊さないよう、既存のコンポーネントファイルを `features` の `ui/` ディレクトリへ移動します。

1. `src/components/GameBoard3D.tsx` → `features/field-grid/ui/`
2. `src/components/Hand3D.tsx` & `Card3D.tsx` → `features/card-hand/ui/`
3. `src/components/GameInfo.tsx` & `UIOverlay.tsx` → `features/hud/ui/`
4. `App.tsx` 内の `TurnEndButton` や `SummonButton` 等の JSX を抽出し、各 feature の `ui/` へ配置。

#### フェーズ 3：ロジック（Domain）の解体と配置

`src/logic/gameLogic.ts` の巨大な関数群を機能ごとに分割します。

1. **ecosystem-activation**: `runAlienActivationPhase`, `runNativeActivationPhase`, `applyGrowthLogic` を移植。
2. **play-card**: `playCardLogic`, `getEffectRange`, `applyAlienCard`, `applyEradicationCard`, `applyRecoveryCard` を移植。
3. **move-alien**: `moveAlienLogic` とバリデーション部分を移植。
4. **turn-system**: `progressTurnLogic` を移植。

#### フェーズ 4：ストア（App/Store）の再構築

1. `src/store/UIStore.ts` を `src/app/store/` へ移動。
2. 盤面データ（`gameField`, `activeAlienInstances`）を管理する `useGameStore.ts` と、純粋な UI 状態（`selectedCardId`, `notification`）を管理する `useUIStore.ts` に分割を検討。

#### フェーズ 5：アプリケーション全体の統合（Glue）

1. `src/App.tsx` を `src/app/App.tsx` へ移動。
2. 分割した各 feature の `index.ts` からコンポーネントやフックを import するように修正。
3. 動作確認を行い、カメラ位置やカード配置、paging 処理がリファクタリング前と完全に一致していることを検証。

---

**次のステップ:**
まずは **フェーズ 1（Shared の構築）** と **フェーズ 2（UI の切り分け）** に必要なファイル作成と移動から開始しましょう。よろしければ、最初のディレクトリ作成と `shared/types` への移行コードから提示します。